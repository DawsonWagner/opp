---
title: "Vod Report"
author: "Samantha Robertson"
date: "11/6/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source(here::here("lib", "opp.R"))
source(here::here("lib", "veil_of_darkness_test.R"))
```

## Load data

```{r}
data <- read_rds(here::here("cache", "vod_dst_data.Rds"))
```


```{r}
min_minutes <-
  data %>% 
  group_by(geo_control) %>% 
  summarise(min_dusk = min(dusk_minute), max_sunset = max(sunset_minute))

data %>% 
  left_join(min_minutes, by = "geo_control") %>% 
  filter(minute >= min_dusk, minute <= max_sunset) %>% 
  count(geo_control, season = month(date) < 6) %>% 
  arrange(desc(n))
```

### summary table

```{r}
data %>% 
  group_by(city) %>% 
  summarise(
    n = n(),
    n_dst = sum(is_dst_period),
    proportion_minority = sum(is_minority_demographic) / n
  ) %>% 
  arrange(desc(n)) %>% 
  knitr::kable()
```

### Find best times


```{r}
data %>% 
  filter(city == "Philadelphia") %>% 
  ggplot(aes(time, fill = is_dark)) +
   geom_density(alpha = 1/2)
```

## Visualize All Stops

```{r}
plot_prop_minority_by_time(
  data, 
  title = "All stops", 
  min_clock_time = hms::hms(hours = 18, min = 30), 
  max_clock_time = hms::hms(hours = 19, min = 30)
)
```

```{r}
plot_prop_minority_by_time(
  filter(data, city != "El Paso"),
  min_clock_time = hms::hms(hours = 18, min = 30), 
  max_clock_time = hms::hms(hours = 19, min = 30),
  smooth_method = "lm"
)
```


```{r}
plot_prop_minority_by_time(
    filter(data, !year(date) %in% c(2007, 2008)),
    city_only = "Madison",
    title = "Madison, WI",
    min_clock_time = hms::hms(hours = 18, min = 30), 
    max_clock_time = hms::hms(hours = 19, min = 30),
    smooth_method = "lm"
  )
````


### Regression Results

```{r}
full_models <- read_rds(here::here("cache", "vod_full_models.Rds"))
full_results <- read_rds(here::here("cache", "vod_full_results.Rds"))
```

#### Summary
```{r}
full_results
```


```{r}
model.minute <- read_rds(here::here("cache", "model_minute_bin.rds"))
model.geo <- read_rds(here::here("cache", "model_geo_adj_minute_bin.rds"))
```

#### Time adjusted only

```{r}
full_models$model_time_const %>% broom::tidy()
```

#### Time and subgeography adjusted

```{r}
full_models$model_geo_adjusted %>% broom::tidy()
```

## Daylight Savings Period

## Regressions

```{r}
dst_fall <- read_rds(here::here("cache", "vod_dst_fall.Rds"))
dst_spring <- read_rds(here::here("cache", "vod_dst_spring.Rds"))
```

#### Summary
```{r}
tribble(
  ~adjustments, ~Fall_logK,  ~Fall_SE, ~Spring_logK,  ~Spring_SE,
  "None",       log(dst_fall$k), NA, log(dst_spring$k),  NA,
  "Clock time", -coef(dst_fall$model_time_const)[2], coef(summary(dst_fall$model_time_const))[2, 2], -coef(dst_spring$model_time_const)[2], coef(summary(dst_spring$model_time_const))[2, 2],
  "Clock time and Subgeography", -coef(dst_fall$model_geo_adjusted)[2], coef(summary(dst_fall$model_geo_adjusted))[2,2], -coef(dst_spring$model_geo_adjusted)[2], coef(summary(dst_spring$model_geo_adjusted))[2,2]
)
```

## Separately on each city


```{r}
by_city <- read_rds(here::here("cache", "vod_geo_adj_by_city.Rds"))

by_city %>%  
  mutate(
    log_k = -estimate, 
    low = log_k - 1.96*std.error, 
    high = log_k + 1.96*std.error
  ) %>% 
  ggplot(aes(reorder(city, log_k), log_k)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_point() +
  geom_errorbar(aes(ymin = low, ymax = high)) +
  theme(
    axis.text.x = element_text(hjust = 1, angle = 30)
  ) +
  labs(
    x = NULL,
    y = "logK with 95% conf int",
    title = "Clock-time, Month and Subgeography Adjusted Models by City"
  )
```


```{r}
by_city_dst <- read_rds(here::here("cache", "vod_dst_by_city.Rds"))

by_city_dst %>%  
  filter(city != "El Paso") %>% 
  mutate(low = estimate - 1.96*std.error, high = estimate + 1.96*std.error) %>% 
  ggplot(aes(reorder(city, estimate), estimate)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_point() +
  geom_errorbar(aes(ymin = low, ymax = high)) +
  theme(
    axis.text.x = element_text(hjust = 1, angle = 30)
  ) +
  labs(
    x = NULL,
    y = "Coefficient on isDarkTRUE with 95% conf int",
    title = "Clock-time and Subgeography Adjusted DST Models by City"
  ) +
  facet_grid(season ~ .)
```

## discontinuity

```{r}
date_lims <- 
  data %>% 
  filter(is_dst_period == TRUE) %>% 
  summarise(min = min(date), max = max(date))

city_years <- 
  data %>% 
  distinct(city, year = year(date))

city_centroids <-
  data %>% 
  group_by(city) %>% 
  summarise(
    lat = median(lat),
    lng = median(lng),
    tz = min(tz)
  )

dst_sunsets <-
  tibble(
     date = seq(date_lims$min, date_lims$max, by = "days")
  ) %>% 
  mutate(
    is_dst = dst(as.POSIXct(date, tz = Sys.timezone())),
    is_dst_tomorrow = lead(is_dst),
    day_of_change = is_dst == FALSE & is_dst_tomorrow == TRUE | 
      is_dst == TRUE & is_dst_tomorrow == FALSE,
    day_before_change = lead(day_of_change) == TRUE
  ) %>% 
  filter(day_of_change == TRUE | day_before_change == TRUE) %>% 
  mutate(
    year = year(date),
    season = if_else(month(date) < 6, "fall", "spring")
  ) %>% 
  select(year, season, date, day_before_change, day_of_change) %>% 
  left_join(city_years, by = "year") %>% 
  left_join(city_centroids, by = "city") %>% 
  mutate(subgeography = city) %>% 
  left_join(infer_sunset_times(.), by = c("date", "tz", "subgeography"))

dst_times <-
  dst_sunsets %>% 
  mutate(
    day = if_else(day_before_change == TRUE, "day_before", "day_of"),
    sunset_minute = hour(hms(sunset)) * 60 + minute(hms(sunset))
  ) %>% 
  select(-day_before_change, -day_of_change, -date, -sunset, -dusk) %>% 
  spread(key = day, value = sunset_minute) %>% 
  mutate(
    earlier = if_else(day_before < day_of, day_before, day_of),
    later = if_else(day_before > day_of, day_before, day_of),
    min_minute = earlier + 20,
    max_minute = earlier + 40
  ) %>% 
  filter(max_minute < later) %>% 
  select(year, season, city, min_minute)

dst_dates <-
  dst_sunsets %>% 
  filter(day_of_change) %>% 
  distinct(year, season, date) %>% 
  select(year, season, dst_date = date)

full_data <-
  data %>% 
  mutate(
    year = year(date),
    season = if_else(month < 6, "fall", "spring")
  ) %>% 
  left_join(dst_dates, by = c("year", "season")) %>% 
  left_join(dst_times, by = c("year", "season", "city")) %>% 
  mutate(days_since_dst = date - dst_date)

plot_data <-
  full_data %>% 
  filter(
    days_since_dst < days(15),
    days_since_dst > days(-15),
    minute >= min_minute,
    minute <= min_minute + 20,
    city != "El Paso"
  ) %>% 
  mutate(
    is_dark = factor(is_dark, levels = c(TRUE, FALSE), labels = c("Dark", "Light"))
  ) %>% 
  group_by(days_since_dst, season, is_dark) %>% 
  summarise(prop_minority = sum(is_minority_demographic) / n(), n = n())
  
plot_data %>% 
  ggplot(aes(days_since_dst, prop_minority)) +
  geom_vline(xintercept = days(0), color = "grey60") +
  geom_point(aes(color = is_dark)) +
  geom_smooth(method = "lm", color = "grey40", se = FALSE) +
  scale_color_manual(values = c("#2b8cbe", "#feb24c")) +
  labs(
    title = "DST Discontinuity (20 minute period) over 9 cities",
    x = "Days since DST change",
    y = "Proportion minority drivers stopped - Mean over cities",
    color = NULL
  ) +
  facet_grid(season ~ .)
```


## Statewide

Choice of states: race & time & county available. chose to override recorded lat/lng (partial in CT, TX, WI; good coverage MT, OH, VT) and drop VT which has only lat/lng no county due to lat/lng errors & for consistency.

```{r}
statewide_results <- read_rds(here::here("cache", "vod_statewide_full_results.Rds"))
statewide_models <- 
  list(
    time_only = read_rds(here::here("cache", "vod_statewide_time_const.rds")),
    time_geo = read_rds(here::here("cache", "vod_statewide_geo_adj.rds"))
  )

tribble(
  ~adjustments, ~logK,                                    ~Standard_Error,
  "None",       statewide_results$log_k,                       NA,
  "Clock time", -statewide_results$coefficients$time_adjusted, statewide_models$time_only$std.error[2],
  "Clock time and Subgeography", -statewide_results$coefficients$time_and_geo_adjusted, statewide_models$time_geo$std.error[2]
)
```


```{r}
statewide_dst_results <- read_rds(here::here("cache", "vod_statewide_dst_results.Rds"))
statewide_dst_models <- read_rds(here::here("cache", "vod_statewide_dst_models.Rds"))

tribble(
  ~adjustments, ~logK,                                    ~Standard_Error,
  "None",       statewide_dst_results$log_k,                       NA,
  "Clock time", -statewide_dst_results$coefficients$time_adjusted, coef(summary(statewide_dst_models$model_time_const))[2, 2],
  "Clock time and Subgeography", -statewide_dst_results$coefficients$time_and_geo_adjusted, coef(summary(statewide_dst_models$model_geo_adjusted))[2,2]
)
```

```{r}
data_states %>% 
  ggplot(aes(time, fill = is_dark)) +
   geom_density(alpha = 1/2)
```

```{r}
discontinuity_states <- read_rds(here::here("cache", "states_dst_discontinuity.rds"))

discontinuity_states %>% 
  group_by(days_since_dst, season, is_dark) %>% 
  summarise(prop_minority = sum(is_minority_demographic) / n(), n = n()) %>% 
  ggplot(aes(days_since_dst, prop_minority)) +
  geom_vline(xintercept = days(0), color = "grey60") +
  geom_point(aes(color = is_dark)) +
  geom_smooth(se = FALSE, method = "lm", color = "grey20") +
  scale_color_manual(values = c("#2b8cbe", "#feb24c")) +
  facet_grid(. ~ season) +
  labs(
    title = "DST Discontinuity (20 minute period) over 10 states",
    x = "Days since DST change",
    y = "Proportion minority drivers stopped - Mean over states",
    color = NULL
  )
```

